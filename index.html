<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lombok Live Chat</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f2f5;
        }
        .chat-container {
            width: 100%;
            max-width: 600px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            height: 80vh;
        }
        .chat-header {
            background-color: #0084ff;
            color: white;
            padding: 15px;
            text-align: center;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
        }
        .chat-body {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: #e5e5e5;
        }
        .chat-message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 10px;
            max-width: 70%;
            word-wrap: break-word;
        }
        .chat-message.sent {
            background-color: #0084ff;
            color: white;
            margin-left: auto;
            text-align: right;
        }
        .chat-message.received {
            background-color: #fff;
            border: 1px solid #ddd;
            margin-right: auto;
        }
        .chat-input {
            display: flex;
            padding: 15px;
            border-top: 1px solid #ddd;
            background-color: #fff;
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
        }
        input[type="text"], input[type="email"], input[type="password"] {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            margin-right: 10px;
            outline: none;
        }
        button {
            padding: 10px 20px;
            background-color: #0084ff;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
        }
        button:hover {
            background-color: #006bb3;
        }
        .auth-container {
            display: none;
            flex-direction: column;
            gap: 10px;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <h2>Lombok Live Chat</h2>
            <button onclick="logout()">Logout</button>
        </div>
        <div class="chat-body" id="chatBody"></div>
        <div class="chat-input">
            <input type="text" id="messageInput" placeholder="Ketik pesan...">
            <button onclick="sendMessage()">Kirim</button>
        </div>
    </div>
    <div class="auth-container" id="authContainer">
        <h2>Login</h2>
        <input type="email" id="emailInput" placeholder="Email">
        <input type="password" id="passwordInput" placeholder="Password">
        <button onclick="login()">Login</button>
        <button onclick="signup()">Daftar</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Inisialisasi Supabase
        if (!window.supabase) {
            console.error('Supabase library not loaded. Please check the CDN URL.');
            alert('Gagal memuat library Supabase. Periksa koneksi atau CDN.');
            throw new Error('Supabase library not loaded');
        }

        const supabaseUrl = 'https://okhxbxybtxijyonfgnuw.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9raHhieHlidHhpanlvbmZnbnV3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEwMDI0MDMsImV4cCI6MjA2NjU3ODQwM30.BOH-M_Q31Arx5tXcWbuuxYvBxTav0o39IPgL4IDfs7c';
        let supabase;
        try {
            supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
            console.log('Supabase client initialized successfully');
        } catch (error) {
            console.error('Error initializing Supabase:', error.message);
            alert('Gagal menginisialisasi Supabase: ' + error.message);
            throw error;
        }

        let currentUser = null;

        // Simpan sesi ke localStorage jika belum ada
        function saveSession(user) {
            try {
                if (!localStorage.getItem('chatUser')) {
                    localStorage.setItem('chatUser', JSON.stringify({
                        id: user.id,
                        email: user.email
                    }));
                    console.log('Session saved to localStorage:', user.email);
                } else {
                    console.log('Session already exists in localStorage, skipping save');
                }
            } catch (error) {
                console.error('Error saving session:', error.message);
            }
        }

        // Ambil sesi dari localStorage
        function getSession() {
            try {
                const session = localStorage.getItem('chatUser');
                return session ? JSON.parse(session) : null;
            } catch (error) {
                console.error('Error getting session:', error.message);
                return null;
            }
        }

        // Hapus sesi dari localStorage
        function clearSession() {
            try {
                if (localStorage.getItem('chatUser')) {
                    localStorage.removeItem('chatUser');
                    console.log('Session cleared from localStorage');
                } else {
                    console.log('No session found in localStorage to clear');
                }
            } catch (error) {
                console.error('Error clearing session:', error.message);
            }
        }

        // Cek status autentikasi
        async function checkAuth() {
            try {
                // Cek localStorage terlebih dahulu
                const storedSession = getSession();
                if (storedSession) {
                    // Validasi sesi dengan Supabase
                    const { data: { user }, error } = await supabase.auth.getUser();
                    if (error) {
                        if (error.message.includes('Auth session missing')) {
                            console.log('No active Supabase session, clearing localStorage');
                            clearSession();
                            currentUser = null;
                        } else {
                            throw error;
                        }
                    } else if (user && user.id === storedSession.id) {
                        currentUser = user;
                        console.log('Current user from session:', currentUser.email);
                    } else {
                        console.log('Invalid session in localStorage, clearing');
                        clearSession();
                        currentUser = null;
                    }
                } else {
                    // Jika tidak ada sesi di localStorage, cek Supabase
                    const { data: { user }, error } = await supabase.auth.getUser();
                    if (error) {
                        if (error.message.includes('Auth session missing')) {
                            console.log('No active Supabase session');
                            currentUser = null;
                        } else {
                            throw error;
                        }
                    } else if (user) {
                        currentUser = user;
                        saveSession(user);
                    }
                }

                if (currentUser) {
                    document.getElementById('authContainer').style.display = 'none';
                    document.getElementById('chatContainer').style.display = 'flex';
                    await fetchMessages();
                    setupRealtime();
                } else {
                    document.getElementById('authContainer').style.display = 'flex';
                    document.getElementById('chatContainer').style.display = 'none';
                }
            } catch (error) {
                console.error('Error checking auth:', error.message);
                // Hanya tampilkan alert untuk error kritis
                if (!error.message.includes('Auth session missing')) {
                    alert('Error autentikasi: ' + error.message);
                }
            }
        }

        // Login
        async function login() {
            try {
                const email = document.getElementById('emailInput').value;
                const password = document.getElementById('passwordInput').value;
                if (!email || !password) {
                    alert('Email dan kata sandi harus diisi.');
                    return;
                }
                const { data: { user }, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
                currentUser = user;
                saveSession(user);
                await checkAuth();
            } catch (error) {
                console.error('Login error:', error.message);
                alert('Error login: ' + error.message);
            }
        }

        // Daftar
        async function signup() {
            try {
                const email = document.getElementById('emailInput').value;
                const password = document.getElementById('passwordInput').value;
                if (!email || !password) {
                    alert('Email dan kata sandi harus diisi.');
                    return;
                }
                const { data: { user }, error } = await supabase.auth.signUp({ email, password });
                if (error) throw error;
                currentUser = user;
                saveSession(user);
                alert('Pendaftaran berhasil! Anda sudah login.');
                await checkAuth();
            } catch (error) {
                console.error('Signup error:', error.message);
                alert('Error daftar: ' + error.message);
            }
        }

        // Logout
        async function logout() {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                currentUser = null;
                clearSession();
                document.getElementById('chatBody').innerHTML = '';
                await checkAuth();
            } catch (error) {
                console.error('Logout error:', error.message);
                alert('Error logout: ' + error.message);
            }
        }

        // Ambil pesan
        async function fetchMessages() {
            try {
                const { data, error } = await supabase
                    .from('messages')
                    .select('*')
                    .order('created_at', { ascending: true });
                if (error) throw error;
                const chatBody = document.getElementById('chatBody');
                chatBody.innerHTML = '';
                if (data && data.length > 0) {
                    data.forEach(message => addMessageToUI(message));
                } else {
                    console.log('No messages found in database');
                    chatBody.innerHTML = '<p>Belum ada pesan.</p>';
                }
                chatBody.scrollTop = chatBody.scrollHeight;
            } catch (error) {
                console.error('Error fetching messages:', error.message);
                alert('Error mengambil pesan: ' + error.message);
            }
        }

        // Tambahkan pesan ke UI
        function addMessageToUI(message) {
            const chatBody = document.getElementById('chatBody');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${message.user_id === currentUser?.id ? 'sent' : 'received'}`;
            messageDiv.innerHTML = `<strong>${message.username}</strong>: ${message.content}<br><small>${new Date(message.created_at).toLocaleTimeString()}</small>`;
            chatBody.appendChild(messageDiv);
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        // Kirim pesan
        async function sendMessage() {
            try {
                if (!currentUser) {
                    alert('Silakan login terlebih dahulu.');
                    return;
                }
                const input = document.getElementById('messageInput');
                const content = input.value.trim();
                if (!content) return;
                const { error } = await supabase
                    .from('messages')
                    .insert([{ content, user_id: currentUser.id, username: currentUser.email }]);
                if (error) throw error;
                input.value = '';
            } catch (error) {
                console.error('Error sending message:', error.message);
                alert('Error mengirim pesan: ' + error.message);
            }
        }

        // Setup real-time
        function setupRealtime() {
            try {
                supabase
                    .channel('public:messages')
                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
                        addMessageToUI(payload.new);
                    })
                    .subscribe((status) => {
                        console.log('Realtime subscription status:', status);
                    });
            } catch (error) {
                console.error('Error setting up realtime:', error.message);
                alert('Error mengatur real-time: ' + error.message);
            }
        }

        // Kirim pesan saat tekan Enter
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Inisialisasi aplikasi
        checkAuth();
    </script>
</body>
</html>